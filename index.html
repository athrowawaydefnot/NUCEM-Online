<!DOCTYPE html>
<html lang="sk">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Slovensk√Ω jazyk - Denn√Ω test N√öCEM</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 900px;
            margin: 0 auto;
        }

        .header {
            background: white;
            padding: 30px;
            border-radius: 15px;
            margin-bottom: 20px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
        }

        .header h1 {
            color: #667eea;
            margin-bottom: 10px;
        }

        .header p {
            color: #666;
        }

        .date-badge {
            display: inline-block;
            background: #667eea;
            color: white;
            padding: 8px 16px;
            border-radius: 20px;
            font-size: 14px;
            margin-top: 10px;
        }

        .card {
            background: white;
            padding: 30px;
            border-radius: 15px;
            margin-bottom: 20px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
        }

        .text-block {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 20px;
            border-left: 4px solid #667eea;
        }

        .text-block h3 {
            color: #667eea;
            margin-bottom: 15px;
        }

        .text-content {
            line-height: 1.8;
            color: #333;
            font-style: italic;
            margin-bottom: 20px;
            padding: 15px;
            background: white;
            border-radius: 5px;
            white-space: pre-wrap;
        }

        .question {
            margin-bottom: 25px;
            padding: 15px;
            background: white;
            border-radius: 8px;
            border: 1px solid #e0e0e0;
        }

        .question-text {
            font-weight: 600;
            color: #333;
            margin-bottom: 12px;
        }

        .options {
            margin-left: 10px;
        }

        .option {
            margin: 8px 0;
            display: flex;
            align-items: center;
        }

        .option input[type="radio"] {
            margin-right: 10px;
            cursor: pointer;
        }

        .option label {
            cursor: pointer;
            color: #555;
        }

        input[type="text"] {
            width: 100%;
            padding: 10px;
            border: 2px solid #e0e0e0;
            border-radius: 5px;
            font-size: 14px;
            transition: border-color 0.3s;
        }

        input[type="text"]:focus {
            outline: none;
            border-color: #667eea;
        }

        .button {
            background: #667eea;
            color: white;
            border: none;
            padding: 15px 40px;
            border-radius: 25px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.4);
        }

        .button:hover {
            background: #5568d3;
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(102, 126, 234, 0.6);
        }

        .button:disabled {
            background: #ccc;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }

        .button-secondary {
            background: #764ba2;
        }

        .button-secondary:hover {
            background: #653a8a;
        }

        .timer {
            position: fixed;
            top: 20px;
            right: 20px;
            background: white;
            padding: 15px 25px;
            border-radius: 25px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.2);
            font-weight: 600;
            color: #667eea;
            font-size: 18px;
        }

        .progress {
            background: #e0e0e0;
            height: 8px;
            border-radius: 4px;
            margin-bottom: 20px;
            overflow: hidden;
        }

        .progress-bar {
            background: #667eea;
            height: 100%;
            transition: width 0.3s;
        }

        .leaderboard {
            margin-top: 20px;
        }

        .leaderboard-item {
            display: flex;
            justify-content: space-between;
            padding: 15px;
            background: #f8f9fa;
            margin-bottom: 10px;
            border-radius: 8px;
            align-items: center;
        }

        .leaderboard-item.top-3 {
            background: linear-gradient(135deg, #ffd89b 0%, #19547b 100%);
            color: white;
            font-weight: 600;
        }

        .rank {
            font-size: 20px;
            font-weight: bold;
            color: #667eea;
            min-width: 40px;
        }

        .leaderboard-item.top-3 .rank {
            color: #fff;
        }

        .score-display {
            text-align: center;
            padding: 40px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border-radius: 15px;
            margin: 20px 0;
        }

        .score-display h2 {
            font-size: 48px;
            margin-bottom: 10px;
        }

        .hidden {
            display: none;
        }

        .loading {
            text-align: center;
            padding: 40px;
            color: #667eea;
        }

        .spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #667eea;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 20px auto;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .error {
            background: #ff4444;
            color: white;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
        }

        .setup-screen {
            text-align: center;
            padding: 40px;
        }

        .setup-screen h2 {
            color: #667eea;
            margin-bottom: 20px;
        }

        .setup-screen input {
            margin: 10px 0;
            max-width: 500px;
        }

        .info-box {
            background: #e3f2fd;
            border-left: 4px solid #2196f3;
            padding: 15px;
            margin: 20px 0;
            border-radius: 5px;
        }

        .share-button {
            background: #25D366;
            margin-left: 10px;
        }

        .share-button:hover {
            background: #1da851;
        }

        .author-info {
            color: #888;
            font-size: 14px;
            margin-bottom: 10px;
            font-style: italic;
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Timer -->
        <div class="timer hidden" id="timer">
            ‚è±Ô∏è <span id="time">00:00</span>
        </div>

        <!-- Setup Screen -->
        <div class="card setup-screen" id="setupScreen">
            <h2>‚öôÔ∏è Nastavenie aplik√°cie</h2>
            <p style="margin-bottom: 20px; color: #666;">Pre pou≈æ√≠vanie aplik√°cie je potrebn√© nastavi≈• Supabase pripojenie.</p>
            
            <div class="info-box">
                <strong>Kde n√°jdem tieto √∫daje?</strong><br>
                1. Prejdite na <a href="https://supabase.com" target="_blank">supabase.com</a><br>
                2. Vytvorte nov√Ω projekt (bezplatn√Ω)<br>
                3. V Settings ‚Üí API n√°jdete URL a anon key
            </div>

            <input type="text" id="supabaseUrl" placeholder="Supabase URL (https://xxx.supabase.co)">
            <input type="text" id="supabaseKey" placeholder="Supabase Anon Key">
            <input type="text" id="openaiKey" placeholder="OpenAI API Key (sk-proj-...)">
            
            <br><br>
            <button class="button" id="saveConfigBtn" onclick="window.saveConfigHandler()">üíæ Ulo≈æi≈• a pokraƒçova≈•</button>
        </div>

        <!-- Main App (initially hidden) -->
        <div id="mainApp" class="hidden">
            <!-- Header -->
            <div class="header">
                <h1>üìö Slovensk√Ω jazyk a literat√∫ra</h1>
                <p>Pr√≠prava na maturity - extern√° ƒças≈• (N√öCEM)</p>
                <div class="date-badge" id="dateDisplay"></div>
            </div>

            <!-- Welcome Screen -->
            <div class="card" id="welcomeScreen">
                <h2 style="color: #667eea; margin-bottom: 20px;">Vitajte v dne≈°nom teste!</h2>
                <p style="margin-bottom: 20px; line-height: 1.6;">
                    Test obsahuje <strong>8 textov√Ωch uk√°≈æok</strong> s celkovo <strong>64 ot√°zkami</strong>.<br>
                    Odpovede sa automaticky vyhodnocuj√∫ a v√°≈° v√Ωsledok sa zarad√≠ do denn√©ho rebr√≠ƒçka.
                </p>
                <div class="info-box">
                    üìä Po dokonƒçen√≠ uvid√≠te svoj v√Ωsledok a poradie medzi ostatn√Ωmi ≈°tudentmi
                </div>
                <button class="button" onclick="startTest()">üöÄ Zaƒça≈• test</button>
                <button class="button button-secondary" style="margin-left: 10px;" onclick="showLeaderboard()">üèÜ Rebr√≠ƒçek</button>
            </div>

            <!-- Test Screen -->
            <div class="card hidden" id="testScreen">
                <div class="progress">
                    <div class="progress-bar" id="progressBar"></div>
                </div>
                <div id="testContent"></div>
                <div style="text-align: center; margin-top: 30px;">
                    <button class="button" onclick="submitTest()">‚úÖ Odovzda≈• test</button>
                </div>
            </div>

            <!-- Results Screen -->
            <div class="card hidden" id="resultsScreen">
                <div class="score-display">
                    <h2 id="finalScore">0/64</h2>
                    <p>√öspe≈°nos≈•: <span id="percentage">0%</span></p>
                    <p>ƒåas: <span id="finalTime">00:00</span></p>
                </div>
                
                <h3 style="color: #667eea; margin-bottom: 15px;">üìä Tvoje umiestnenie</h3>
                <div id="userRanking"></div>

                <div style="text-align: center; margin-top: 20px;">
                    <button class="button" onclick="showLeaderboard()">üèÜ Pozrie≈• cel√Ω rebr√≠ƒçek</button>
                    <button class="button share-button" onclick="shareResults()">üì§ Zdieƒæa≈• v√Ωsledok</button>
                </div>
            </div>

            <!-- Leaderboard Screen -->
            <div class="card hidden" id="leaderboardScreen">
                <h2 style="color: #667eea; margin-bottom: 20px;">üèÜ Denn√Ω rebr√≠ƒçek</h2>
                <div class="leaderboard" id="leaderboardContent"></div>
                <div style="text-align: center; margin-top: 20px;">
                    <button class="button" onclick="showWelcome()">‚Üê Sp√§≈•</button>
                </div>
            </div>

            <!-- Loading Screen -->
            <div class="card hidden" id="loadingScreen">
                <div class="loading">
                    <div class="spinner"></div>
                    <p>Naƒç√≠tavam test... (trv√° 30-60 sek√∫nd)</p>
                </div>
            </div>
        </div>
    </div>

    <script>
        // ============================================
        // CONFIGURATION & INITIALIZATION
        // ============================================
        
        let supabaseClient;
        let config = {
            supabaseUrl: '',
            supabaseKey: '',
            openaiKey: ''
        };

        // Load config from localStorage
        function loadConfig() {
            const saved = localStorage.getItem('maturita_config');
            if (saved) {
                config = JSON.parse(saved);
                initializeSupabase();
                return true;
            }
            return false;
        }

        function saveConfig() {
            console.log('saveConfig called!');
            const url = document.getElementById('supabaseUrl').value.trim();
            const key = document.getElementById('supabaseKey').value.trim();
            const openai = document.getElementById('openaiKey').value.trim();

            console.log('Values:', { url, key: key.substring(0, 20) + '...', openai: openai.substring(0, 20) + '...' });

            if (!url || !key || !openai) {
                alert('Pros√≠m vypl≈àte v≈°etky polia!');
                return;
            }

            config = { supabaseUrl: url, supabaseKey: key, openaiKey: openai };
            localStorage.setItem('maturita_config', JSON.stringify(config));
            
            console.log('Config saved, initializing Supabase...');
            initializeSupabase();
            
            console.log('Hiding setup screen...');
            document.getElementById('setupScreen').classList.add('hidden');
            document.getElementById('mainApp').classList.remove('hidden');
            init();
        }

        // Global handler for onclick
        window.saveConfigHandler = saveConfig;

        function initializeSupabase() {
            supabaseClient = window.supabase.createClient(config.supabaseUrl, config.supabaseKey);
        }

        // ============================================
        // DATA ABSTRACTION LAYER
        // ============================================
        
        const dbStorage = {
            async getTodayTest() {
                const today = new Date().toISOString().split('T')[0];
                const { data, error } = await supabaseClient
                    .from('tests')
                    .select('*')
                    .eq('date', today)
                    .single();
                
                if (error && error.code !== 'PGRST116') {
                    console.error('Error fetching test:', error);
                    return null;
                }
                return data;
            },

            async saveTest(test) {
                const { data, error } = await supabaseClient
                    .from('tests')
                    .insert([test])
                    .select();
                
                if (error) {
                    console.error('Error saving test:', error);
                    return null;
                }
                return data[0];
            },

            async submitScore(entry) {
                const { data, error } = await supabaseClient
                    .from('leaderboard')
                    .insert([entry])
                    .select();
                
                if (error) {
                    console.error('Error submitting score:', error);
                    return null;
                }
                return data[0];
            },

            async getLeaderboard() {
                const today = new Date().toISOString().split('T')[0];
                const { data, error } = await supabaseClient
                    .from('leaderboard')
                    .select('*')
                    .eq('date', today)
                    .order('score', { ascending: false })
                    .order('time_seconds', { ascending: true });
                
                if (error) {
                    console.error('Error fetching leaderboard:', error);
                    return [];
                }
                return data;
            }
        };

        // ============================================
        // AI TEST GENERATION (ENHANCED WITH REAL N√öCEM EXAMPLES)
        // ============================================
        
        async function generateTest() {
            const systemPrompt = `Si expert na tvorbu testov pre slovensk√∫ maturity (N√öCEM - Slovensk√Ω jazyk a literat√∫ra, extern√° ƒças≈•).

FORM√ÅT TESTU (PRESNE DODR≈ΩA≈§):
- 8 textov√Ωch uk√°≈æok (blocks)
- Ka≈æd√° uk√°≈æka m√° presne 8 ot√°zok
- Celkovo 64 ot√°zok
- 40 ot√°zok = multiple choice (4 mo≈ænosti, 1 spr√°vna)
- 24 ot√°zok = short answer (kr√°tka odpoveƒè, 1-3 slov√°)

ROZDELENIE TEXTOV√ùCH UK√Å≈ΩOK:
1. Klasick√° slovensk√° pr√≥za (realizmus/medzivojnov√© obdobie) - autor: Milo Urban, Jozef C√≠ger Hronsk√Ω, Dobroslav Chrob√°k
2. Slovensk√° po√©zia (romantizmus/moderna) - autor: Andrej Sl√°dkoviƒç, J√°n Smrek, Ivan Krasko
3. Svetov√° pr√≥za (19.-20. storoƒçie) - autor: Erich Maria Remarque, William Shakespeare
4. Svetov√° po√©zia (romantizmus) - autor: Alexander Sergejeviƒç Pu≈°kin, Lord Byron
5. Publicistick√Ω text (n√°uƒçno-popul√°rny ƒçl√°nok) - t√©ma: veda, zdravie, psychol√≥gia
6. Slovensk√° dr√°ma - autor: Jozef Gregor Tajovsk√Ω
7. Esej/√∫vaha (s√∫ƒçasn√° literat√∫ra)
8. Liter√°rna kritika/recenzia

DISTRIB√öCIA OT√ÅZOK (PRESNE):
- 35% porozumenie textu (comprehension)
- 25% liter√°rna te√≥ria a hist√≥ria
- 20% gramatika a syntax
- 15% lexikol√≥gia a ≈°t√Ωl
- 5% spracovanie inform√°ci√≠

TYPY OT√ÅZOK MULTIPLE CHOICE - pou≈æ√≠vaj presne tieto vzory:

POROZUMENIE TEXTU:
- "Ktor√© tvrdenie vypl√Ωva z uk√°≈æky?"
- "Ktor√° z nasleduj√∫cich charakterist√≠k postavy nevypl√Ωva z uk√°≈æky?"
- "Z uk√°≈æky vypl√Ωva, ≈æe..."

LITER√ÅRNE POJMY:
- "V ktorej mo≈ænosti sa nach√°dza metafora/epiteton/personifik√°cia?"
- "Ktor√Ω umeleck√Ω jazykov√Ω prostriedok sa nach√°dza vo zv√Ωraznenej ƒçasti?"
- "Ak√Ω druh r√Ωmu pou≈æil autor?"

GRAMATIKA:
- "V ktorej mo≈ænosti doch√°dza k znelostnej asimil√°cii/spodobovaniu?"
- "V ktorej mo≈ænosti sa nach√°dza neurƒçit√Ω slovesn√Ω tvar?"
- "V ktorej vete sa nach√°dza priamy predmet?"
- "Ktor√© slovo sa od ostatn√Ωch l√≠≈°i poƒçtom slab√≠k?"

LITER√ÅRNA HIST√ìRIA:
- "Do ktorej literat√∫ry/liter√°rneho obdobia zaraƒèujeme tvorbu autora?"
- "Do ktor√©ho liter√°rneho smeru sa zaraƒèuje preva≈æn√° ƒças≈• tvorby autora?"

TYPY OT√ÅZOK SHORT ANSWER - pou≈æ√≠vaj presne tieto vzory:

GRAMATIKA:
- "Vyp√≠≈°te z uk√°≈æky slovo, v ktorom doch√°dza k..." (spr√°vna odpoveƒè: 1 slovo)
- "Nap√≠≈°te slovo [X] v tvare genit√≠vu singul√°ru." (spr√°vna odpoveƒè: sklo≈àovan√Ω tvar)
- "Vyp√≠≈°te z uk√°≈æky neplnov√Ωznamov√© f√°zov√© sloveso." (spr√°vna odpoveƒè: napr. "zaƒçal")
- "Nap√≠≈°te z√°kladn√Ω tvar slovesa..." (spr√°vna odpoveƒè: infinit√≠v)

SYNTAX:
- "Pomenujte vetn√Ω sklad v nasleduj√∫cej vete." (spr√°vna odpoveƒè: napr. "prisudzovac√≠")

LITER√ÅRNA HIST√ìRIA:
- "Nap√≠≈°te n√°zov diela [autora]..." (spr√°vna odpoveƒè: n√°zov diela)
- "Do ktor√©ho liter√°rneho smeru sa zaraƒèuje autor?" (spr√°vna odpoveƒè: napr. "romantizmus")

LEXIKOL√ìGIA:
- "Nap√≠≈°te n√°zov slovotvorn√©ho postupu..." (spr√°vna odpoveƒè: napr. "skladanie")
- "Vyp√≠≈°te z uk√°≈æky slovo cudzieho p√¥vodu..." (spr√°vna odpoveƒè: 1 slovo)

PRAVOPIS:
- "Vyp√≠≈°te z uk√°≈æky dom√°ce slovo so zdvojenou spoluhl√°skou." (spr√°vna odpoveƒè: napr. "denn√Ω")

PR√çKLADY RE√ÅLNYCH OT√ÅZOK Z N√öCEM TESTOV:

Multiple Choice pr√≠klad 1:
"Ktor√© tvrdenie vypl√Ωva z uk√°≈æky 1?"
(A) ƒålovek, ktor√Ω sa pri vykon√°van√≠ pohybovej aktivity zameriava na svoju techniku pohybu, b√Ωva vyƒçerpanej≈°√≠.
(B) ≈†portov√≠ tr√©neri odpor√∫ƒçaj√∫ profesion√°lnym be≈æcom zamera≈• sa na efekt√≠vnu spotrebu kysl√≠ka.
(C) Tvrdenie o rozpt√Ωlen√≠ je subjekt√≠vne.
(D) V√Ωsledky v√Ωskumu s√∫ v rozpore s te√≥riou.
Spr√°vna odpoveƒè: (A)

Multiple Choice pr√≠klad 2:
"V ktorej mo≈ænosti sa nach√°dza metafora?"
(A) nechcem jeho statky
(B) majetok v √∫cte ma≈•
(C) dvor s dobytkom
(D) hlas svedomia
Spr√°vna odpoveƒè: (D)

Multiple Choice pr√≠klad 3:
"V ktorej mo≈ænosti doch√°dza k znelostnej asimil√°cii/spodobovaniu?"
(A) iba kupova≈• farby
(B) sp√¥sobi≈• si ‚Äûmaliarsky lake≈•"
(C) hudbe, intenz√≠vne maƒæujem
(D) nemohol pohn√∫≈• rukou
Spr√°vna odpoveƒè: (B)

Short Answer pr√≠klad 1:
"Nap√≠≈°te slovo ch√¥dza v tvare genit√≠vu singul√°ru."
Spr√°vna odpoveƒè: "ch√¥dze"

Short Answer pr√≠klad 2:
"Vyp√≠≈°te z ot√°zok neplnov√Ωznamov√© f√°zov√© sloveso."
Spr√°vna odpoveƒè: "zaƒçal"

Short Answer pr√≠klad 3:
"Nap√≠≈°te n√°zov slovotvorn√©ho postupu, ktor√Ωm vznikli slov√° novostavba a maloobchod."
Spr√°vna odpoveƒè: "skladanie"

GRAMATICK√â PRAVIDL√Å NA TESTOVANIE:
- Znelostn√° asimil√°cia (spodobovanie)
- Rytmick√© kr√°tenie
- Sklo≈àovanie cudz√≠ch slov
- Sklo≈àovanie zvierac√≠ch podstatn√Ωch mien
- Pravopis ƒç√≠sloviek
- Interpunkcia (ƒçiarky v s√∫vet√≠)
- Vetn√© ƒçleny (pr√≠stavok, predmet, pr√≠vlastok)

ƒåASTO TESTOVAN√ç AUTORI:
- Slovensk√° literat√∫ra: Andrej Sl√°dkoviƒç, Jozef Gregor Tajovsk√Ω, Martin Kukuƒç√≠n, Milo Urban, Dobroslav Chrob√°k, Ivan Krasko, J√°n Smrek, Milan R√∫fus, Dominik Tatarka
- Svetov√° literat√∫ra: William Shakespeare, Erich Maria Remarque, Alexander Sergejeviƒç Pu≈°kin

PR√çKLAD TEXTOVEJ UK√Å≈ΩKY (Klasick√° slovensk√° pr√≥za):
N√°zov: ≈Ωiv√Ω biƒç
Autor: Milo Urban
Text: "Ale vtedy, asi po troch rokoch, na jar, pri≈°iel do R√°ztok ƒçlovek v zapr√°≈°enej vojenskej uniforme, odst√°vaj√∫cej od predƒçasne vyschnut√©ho tela. Bol nahnut√Ω k zemi, a ako ≈°iel, vietor, ƒço dobehol ƒçasom od h√¥r, svie≈æi, ihrav√Ω, nadn√°≈°al mu prav√Ω ruk√°v, v ktorom nebolo ruky. Tv√°rou od prav√©ho oka, tro≈°ku pri≈æm√∫ren√©ho, tiahla sa mu dlh√° jazva..."

PR√çKLAD TEXTOVEJ UK√Å≈ΩKY (Po√©zia):
N√°zov: Desiate prik√°zanie
Autor: Alexander Sergejeviƒç Pu≈°kin
Text: "Majetok cudz√≠ v √∫cte ma≈• / k√°≈æe n√°m z√°kon vekmi v≈æit√Ω; / nema≈• tak, bo≈æe, ne≈æn√© city, / vedel by som ho dodr≈æa≈•. / Ukr√°ti≈• bl√≠≈æneho, to nikdy, / nechcem ja jeho statky, dom..."

PR√çKLAD TEXTOVEJ UK√Å≈ΩKY (Publicistika):
N√°zov: Ak beh√°te s hudbou, pohyb je efekt√≠vnej≈°√≠
Zdroj: Denn√≠k N
Text: "Nov√° ≈°t√∫dia o behu naznaƒçuje, ≈æe ƒç√≠m viac sa pri pohybe s√∫stred√≠me na to, ako ho vykon√°vame, t√Ωm je pre n√°s nam√°havej≈°√≠. Len ƒço v≈°ak n√°jdeme urƒçit√© rozpt√Ωlenie, vynalo≈æen√© √∫silie bude pre na≈°e telo menej n√°roƒçn√©..."

PO≈ΩIADAVKY NA GENEROVAN√ù TEST:
1. Ka≈æd√° uk√°≈æka mus√≠ ma≈• 150-300 slov
2. Texty musia by≈• realistick√© (nie generick√Ω AI jazyk)
3. Ot√°zky musia by≈• PRESNE v slovenƒçine ako v re√°lnych testoch
4. Gramatick√© ot√°zky musia testova≈• konkr√©tne pravidl√°
5. Short answer ot√°zky musia ma≈• JEDNU presne definovan√∫ spr√°vnu odpoveƒè
6. Multiple choice mus√≠ ma≈• 4 mo≈ænosti (A, B, C, D)

V√ùSTUPN√ù JSON FORM√ÅT:
{
  "blocks": [
    {
      "title": "N√°zov diela / typ textu",
      "text": "Cel√Ω text uk√°≈æky (150-300 slov)",
      "author": "Meno autora",
      "genre": "pr√≥za/po√©zia/publicistika/dr√°ma/esej",
      "questions": [
        {
          "id": 1,
          "question": "Text ot√°zky presne ako v N√öCEM",
          "type": "multiple_choice",
          "options": ["A", "B", "C", "D"],
          "correct": "A"
        },
        {
          "id": 2,
          "question": "Text ot√°zky presne ako v N√öCEM",
          "type": "short_answer",
          "correct": "presn√° odpoveƒè"
        }
      ]
    }
  ]
}

KRITICK√â PRAVIDL√Å:
- 5 ot√°zok MUSIA by≈• multiple choice
- 3 ot√°zky MUSIA by≈• short answer
- Ot√°zky musia pokr√Ωva≈•: porozumenie (2-3), gramatiku (2-3), liter√°rnu te√≥riu (1-2), lexikol√≥giu (1)
- Nepou≈æ√≠vaj fr√°zy ako "based on", "according to" - p√≠≈° prirodzene po slovensky
- Short answer odpovede musia by≈• PRESN√â (nie "pribli≈æne" ani "mo≈æno")
- Ka≈æd√Ω text mus√≠ by≈• in√Ω ≈æ√°ner`;

            const userPrompt = `Vygeneruj komplexn√Ω test na slovensk√∫ maturity (N√öCEM ≈°t√Ωl) presne podƒæa ≈°pecifik√°cie.

DISTRIB√öCIA 8 UK√Å≈ΩOK:
1. Klasick√° slovensk√° pr√≥za (Milo Urban / Jozef C√≠ger Hronsk√Ω)
2. Slovensk√° po√©zia (Ivan Krasko / J√°n Smrek)
3. Svetov√° pr√≥za (Erich Maria Remarque)
4. Svetov√° po√©zia (Alexander Pu≈°kin / Lord Byron)
5. Publicistick√Ω text (n√°uƒçno-popul√°rny ƒçl√°nok o psychol√≥gii/vede)
6. Slovensk√° dr√°ma (Jozef Gregor Tajovsk√Ω)
7. S√∫ƒçasn√° esej/√∫vaha
8. Liter√°rna kritika

Ka≈æd√° uk√°≈æka: presne 8 ot√°zok (5 MC + 3 short answer).

Vr√°≈• V√ùLUƒåNE validn√Ω JSON bez ak√Ωchkoƒævek MarkDown blokov, √∫vodn√Ωch textov alebo vysvetlen√≠.`;

            const response = await fetch('https://api.openai.com/v1/chat/completions', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${config.openaiKey}`
                },
                body: JSON.stringify({
                    model: 'gpt-4o',
                    messages: [
                        { role: 'system', content: systemPrompt },
                        { role: 'user', content: userPrompt }
                    ],
                    temperature: 0.9,
                    response_format: { type: "json_object" }
                })
            });

            if (!response.ok) {
                const errorData = await response.json();
                throw new Error(errorData.error?.message || 'OpenAI API error');
            }

            const result = await response.json();
            const content = result.choices[0].message.content;
            
            // Parse JSON (handle potential wrapper)
            let parsed;
            try {
                parsed = JSON.parse(content);
            } catch (e) {
                // Try to extract JSON from markdown code blocks
                const jsonMatch = content.match(/```json\n?([\s\S]*?)\n?```/);
                if (jsonMatch) {
                    parsed = JSON.parse(jsonMatch[1]);
                } else {
                    parsed = JSON.parse(content);
                }
            }
            
            return parsed;
        }

        // ============================================
        // APP STATE
        // ============================================
        
        let currentTest = null;
        let startTime = null;
        let timerInterval = null;
        let userAnswers = {};

        // ============================================
        // UI FUNCTIONS
        // ============================================
        
        function showScreen(screenId) {
            ['welcomeScreen', 'testScreen', 'resultsScreen', 'leaderboardScreen', 'loadingScreen'].forEach(id => {
                document.getElementById(id).classList.add('hidden');
            });
            document.getElementById(screenId).classList.remove('hidden');
        }

        function showWelcome() {
            showScreen('welcomeScreen');
            stopTimer();
        }

        function updateProgress() {
            const answered = Object.keys(userAnswers).length;
            const total = currentTest ? currentTest.blocks.reduce((sum, b) => sum + b.questions.length, 0) : 64;
            const percent = (answered / total) * 100;
            document.getElementById('progressBar').style.width = percent + '%';
        }

        // ============================================
        // TIMER
        // ============================================
        
        function startTimer() {
            startTime = Date.now();
            document.getElementById('timer').classList.remove('hidden');
            timerInterval = setInterval(updateTimer, 1000);
        }

        function updateTimer() {
            const elapsed = Math.floor((Date.now() - startTime) / 1000);
            const minutes = Math.floor(elapsed / 60);
            const seconds = elapsed % 60;
            document.getElementById('time').textContent = 
                `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
        }

        function stopTimer() {
            if (timerInterval) {
                clearInterval(timerInterval);
                timerInterval = null;
            }
            document.getElementById('timer').classList.add('hidden');
        }

        function getElapsedSeconds() {
            return Math.floor((Date.now() - startTime) / 1000);
        }

        // ============================================
        // TEST FUNCTIONS
        // ============================================
        
        async function startTest() {
            showScreen('loadingScreen');
            
            // Try to get today's test
            let test = await dbStorage.getTodayTest();
            
            if (!test) {
                // Generate new test
                try {
                    const testData = await generateTest();
                    const today = new Date().toISOString().split('T')[0];
                    test = {
                        date: today,
                        content: testData
                    };
                    await dbStorage.saveTest(test);
                } catch (error) {
                    alert('Chyba pri generovan√≠ testu: ' + error.message);
                    showWelcome();
                    return;
                }
            }

            currentTest = test.content;
            userAnswers = {};
            renderTest();
            showScreen('testScreen');
            startTimer();
        }

        function renderTest() {
            const container = document.getElementById('testContent');
            container.innerHTML = '';

            currentTest.blocks.forEach((block, blockIdx) => {
                const blockDiv = document.createElement('div');
                blockDiv.className = 'text-block';
                
                let authorInfo = '';
                if (block.author) {
                    authorInfo = `<p class="author-info">${block.author}${block.genre ? ` ‚Ä¢ ${block.genre}` : ''}</p>`;
                }
                
                blockDiv.innerHTML = `
                    <h3>Uk√°≈æka ${blockIdx + 1}: ${block.title}</h3>
                    ${authorInfo}
                    <div class="text-content">${block.text}</div>
                `;

                block.questions.forEach((q, qIdx) => {
                    const questionDiv = document.createElement('div');
                    questionDiv.className = 'question';
                    
                    const questionId = `q_${blockIdx}_${qIdx}`;
                    
                    if (q.type === 'multiple_choice') {
                        questionDiv.innerHTML = `
                            <div class="question-text">${qIdx + 1}. ${q.question}</div>
                            <div class="options">
                                ${q.options.map((opt, optIdx) => `
                                    <div class="option">
                                        <input type="radio" 
                                               name="${questionId}" 
                                               id="${questionId}_${optIdx}"
                                               value="${opt}"
                                               onchange="saveAnswer('${questionId}', '${opt}')">
                                        <label for="${questionId}_${optIdx}">${opt}</label>
                                    </div>
                                `).join('')}
                            </div>
                        `;
                    } else {
                        questionDiv.innerHTML = `
                            <div class="question-text">${qIdx + 1}. ${q.question}</div>
                            <input type="text" 
                                   id="${questionId}"
                                   placeholder="Va≈°a odpoveƒè..."
                                   onchange="saveAnswer('${questionId}', this.value)">
                        `;
                    }
                    
                    blockDiv.appendChild(questionDiv);
                });

                container.appendChild(blockDiv);
            });
        }

        function saveAnswer(questionId, answer) {
            userAnswers[questionId] = answer;
            updateProgress();
        }

        function normalizeAnswer(str) {
            return str.toLowerCase()
                .trim()
                .normalize('NFD')
                .replace(/[\u0300-\u036f]/g, '') // Remove diacritics for comparison
                .replace(/\s+/g, ' ')
                .replace(/[.,;:!?]/g, '');
        }

        async function submitTest() {
            const totalQuestions = currentTest.blocks.reduce((sum, b) => sum + b.questions.length, 0);
            const answeredCount = Object.keys(userAnswers).length;

            if (answeredCount < totalQuestions) {
                if (!confirm(`Odpovedali ste na ${answeredCount} z ${totalQuestions} ot√°zok. Chcete test naozaj odovzda≈•?`)) {
                    return;
                }
            }

            stopTimer();
            const timeSeconds = getElapsedSeconds();

            // Calculate score
            let correct = 0;
            currentTest.blocks.forEach((block, blockIdx) => {
                block.questions.forEach((q, qIdx) => {
                    const questionId = `q_${blockIdx}_${qIdx}`;
                    const userAnswer = userAnswers[questionId];
                    
                    if (!userAnswer) return;

                    if (q.type === 'multiple_choice') {
                        if (userAnswer === q.correct) correct++;
                    } else {
                        // Normalize for flexible matching
                        if (normalizeAnswer(userAnswer) === normalizeAnswer(q.correct)) {
                            correct++;
                        }
                    }
                });
            });

            // Show results
            document.getElementById('finalScore').textContent = `${correct}/${totalQuestions}`;
            document.getElementById('percentage').textContent = `${Math.round((correct / totalQuestions) * 100)}%`;
            
            const minutes = Math.floor(timeSeconds / 60);
            const seconds = timeSeconds % 60;
            document.getElementById('finalTime').textContent = 
                `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;

            // Save to leaderboard
            const userName = prompt('Zadajte va≈°e meno pre rebr√≠ƒçek:') || 'Anonym';
            const today = new Date().toISOString().split('T')[0];
            
            await dbStorage.submitScore({
                date: today,
                name: userName,
                score: correct,
                time_seconds: timeSeconds,
                timestamp: new Date().toISOString()
            });

            // Show user ranking
            const leaderboard = await dbStorage.getLeaderboard();
            const userEntries = leaderboard.filter(entry => 
                entry.name === userName && 
                entry.score === correct && 
                entry.time_seconds === timeSeconds
            );
            
            const userEntry = userEntries[userEntries.length - 1];
            const userRank = leaderboard.indexOf(userEntry) + 1;

            document.getElementById('userRanking').innerHTML = `
                <div class="leaderboard-item" style="background: #667eea; color: white;">
                    <div>
                        <span class="rank" style="color: white;">#${userRank}</span>
                        <strong>${userName}</strong>
                    </div>
                    <div>
                        ${correct}/${totalQuestions} bodov | ${minutes}:${seconds.toString().padStart(2, '0')}
                    </div>
                </div>
            `;

            showScreen('resultsScreen');
        }

        async function showLeaderboard() {
            showScreen('loadingScreen');
            const leaderboard = await dbStorage.getLeaderboard();
            
            const container = document.getElementById('leaderboardContent');
            
            if (leaderboard.length === 0) {
                container.innerHTML = '<p style="text-align: center; color: #888;">Zatiaƒæ nikto nevyplnil dne≈°n√Ω test.</p>';
            } else {
                container.innerHTML = leaderboard.map((entry, idx) => {
                    const minutes = Math.floor(entry.time_seconds / 60);
                    const seconds = entry.time_seconds % 60;
                    const isTop3 = idx < 3;
                    
                    return `
                        <div class="leaderboard-item ${isTop3 ? 'top-3' : ''}">
                            <div>
                                <span class="rank">#${idx + 1}</span>
                                <strong>${entry.name}</strong>
                            </div>
                            <div>
                                ${entry.score}/64 bodov | ${minutes}:${seconds.toString().padStart(2, '0')}
                            </div>
                        </div>
                    `;
                }).join('');
            }
            
            showScreen('leaderboardScreen');
        }

        function shareResults() {
            const score = document.getElementById('finalScore').textContent;
            const percentage = document.getElementById('percentage').textContent;
            const url = window.location.href;
            
            const text = `üìö Moja dne≈°n√° maturita z SJL:\n${score} (${percentage})\n\nSk√∫s to aj ty: ${url}`;
            
            if (navigator.share) {
                navigator.share({ text });
            } else {
                navigator.clipboard.writeText(text);
                alert('Text skop√≠rovan√Ω do schr√°nky!');
            }
        }

        // ============================================
        // INITIALIZATION
        // ============================================
        
        function init() {
            const today = new Date();
            const options = { year: 'numeric', month: 'long', day: 'numeric' };
            document.getElementById('dateDisplay').textContent = today.toLocaleDateString('sk-SK', options);
        }

        // Start app
        window.addEventListener('DOMContentLoaded', () => {
            // Setup save config button
            const saveBtn = document.getElementById('saveConfigBtn');
            if (saveBtn) {
                saveBtn.addEventListener('click', saveConfig);
            }

            if (loadConfig()) {
                document.getElementById('setupScreen').classList.add('hidden');
                document.getElementById('mainApp').classList.remove('hidden');
                init();
            }
        });
    </script>
</body>
</html>
