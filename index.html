<!DOCTYPE html>
<html lang="sk">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Slovensk√Ω jazyk - Denn√Ω test N√öCEM</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 900px;
            margin: 0 auto;
        }

        .header {
            background: white;
            padding: 30px;
            border-radius: 15px;
            margin-bottom: 20px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
        }

        .header h1 {
            color: #667eea;
            margin-bottom: 10px;
        }

        .header p {
            color: #666;
        }

        .date-badge {
            display: inline-block;
            background: #667eea;
            color: white;
            padding: 8px 16px;
            border-radius: 20px;
            font-size: 14px;
            margin-top: 10px;
        }

        .card {
            background: white;
            padding: 30px;
            border-radius: 15px;
            margin-bottom: 20px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
        }

        .text-block {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 20px;
            border-left: 4px solid #667eea;
        }

        .text-block h3 {
            color: #667eea;
            margin-bottom: 15px;
        }

        .text-content {
            line-height: 1.8;
            color: #333;
            font-style: italic;
            margin-bottom: 20px;
            padding: 15px;
            background: white;
            border-radius: 5px;
            white-space: pre-wrap;
        }

        .highlight {
            background: #ffeb3b;
            padding: 2px 4px;
            border-radius: 3px;
            font-weight: 600;
        }

        .question {
            margin-bottom: 25px;
            padding: 15px;
            background: white;
            border-radius: 8px;
            border: 1px solid #e0e0e0;
        }

        .question.correct { 
            border-left: 4px solid #4caf50; 
            background: #f1f8f4; 
        }
        
        .question.incorrect { 
            border-left: 4px solid #f44336; 
            background: #fef5f5; 
        }

        .question-text {
            font-weight: 600;
            color: #333;
            margin-bottom: 12px;
        }

        .answer-indicator {
            margin-top: 10px;
            padding: 10px;
            border-radius: 5px;
            font-size: 14px;
        }
        
        .answer-indicator.correct { 
            background: #c8e6c9; 
            color: #2e7d32; 
        }
        
        .answer-indicator.incorrect { 
            background: #ffcdd2; 
            color: #c62828; 
        }

        .option.correct-answer { 
            background: #c8e6c9; 
            padding: 5px; 
            border-radius: 5px; 
            font-weight: 600; 
        }
        
        .option.user-wrong { 
            background: #ffcdd2; 
            padding: 5px; 
            border-radius: 5px; 
        }

        .options {
            margin-left: 10px;
        }

        .option {
            margin: 8px 0;
            display: flex;
            align-items: center;
        }

        .option input[type="radio"] {
            margin-right: 10px;
            cursor: pointer;
        }

        .option label {
            cursor: pointer;
            color: #555;
        }

        input[type="text"] {
            width: 100%;
            padding: 10px;
            border: 2px solid #e0e0e0;
            border-radius: 5px;
            font-size: 14px;
            transition: border-color 0.3s;
        }

        input[type="text"]:focus {
            outline: none;
            border-color: #667eea;
        }

        .button {
            background: #667eea;
            color: white;
            border: none;
            padding: 15px 40px;
            border-radius: 25px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.4);
        }

        .button:hover {
            background: #5568d3;
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(102, 126, 234, 0.6);
        }

        .button:disabled {
            background: #ccc;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }

        .button-secondary {
            background: #764ba2;
        }

        .button-secondary:hover {
            background: #653a8a;
        }

        .timer {
            position: fixed;
            top: 20px;
            right: 20px;
            background: white;
            padding: 15px 25px;
            border-radius: 25px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.2);
            font-weight: 600;
            color: #667eea;
            font-size: 18px;
        }

        .progress {
            background: #e0e0e0;
            height: 8px;
            border-radius: 4px;
            margin-bottom: 20px;
            overflow: hidden;
        }

        .progress-bar {
            background: #667eea;
            height: 100%;
            transition: width 0.3s;
        }

        .leaderboard {
            margin-top: 20px;
        }

        .leaderboard-item {
            display: flex;
            justify-content: space-between;
            padding: 15px;
            background: #f8f9fa;
            margin-bottom: 10px;
            border-radius: 8px;
            align-items: center;
        }

        .leaderboard-item.top-3 {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            font-weight: 600;
        }
        
        .leaderboard-item.rank-1 {
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
            box-shadow: 0 4px 15px rgba(245, 87, 108, 0.4);
        }
        
        .leaderboard-item.rank-2 {
            background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
            box-shadow: 0 4px 15px rgba(79, 172, 254, 0.4);
        }
        
        .leaderboard-item.rank-3 {
            background: linear-gradient(135deg, #43e97b 0%, #38f9d7 100%);
            box-shadow: 0 4px 15px rgba(67, 233, 123, 0.4);
        }

        .rank {
            font-size: 20px;
            font-weight: bold;
            color: #667eea;
            min-width: 40px;
        }

        .leaderboard-item.top-3 .rank {
            color: #fff;
        }

        .score-display {
            text-align: center;
            padding: 40px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border-radius: 15px;
            margin: 20px 0;
        }

        .score-display h2 {
            font-size: 48px;
            margin-bottom: 10px;
        }

        .hidden {
            display: none;
        }

        .loading {
            text-align: center;
            padding: 40px;
            color: #667eea;
        }

        .spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #667eea;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 20px auto;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .error {
            background: #ff4444;
            color: white;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
        }

        .setup-screen {
            text-align: center;
            padding: 40px;
        }

        .setup-screen h2 {
            color: #667eea;
            margin-bottom: 20px;
        }

        .setup-screen input {
            margin: 10px 0;
            max-width: 500px;
        }

        .info-box {
            background: #e3f2fd;
            border-left: 4px solid #2196f3;
            padding: 15px;
            margin: 20px 0;
            border-radius: 5px;
        }

        .share-button {
            background: #25D366;
            margin-left: 10px;
        }

        .share-button:hover {
            background: #1da851;
        }

        .author-info {
            color: #888;
            font-size: 14px;
            margin-bottom: 10px;
            font-style: italic;
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Timer -->
        <div class="timer hidden" id="timer">
            ‚è±Ô∏è <span id="time">00:00</span>
        </div>

        <!-- Main App -->
        <div id="mainApp">
            <!-- Header -->
            <div class="header">
                <h1>üìö Slovensk√Ω jazyk a literat√∫ra</h1>
                <p>Pr√≠prava na maturity - extern√° ƒças≈• (N√öCEM)</p>
                <div class="date-badge" id="dateDisplay"></div>
            </div>

            <!-- Welcome Screen -->
            <div class="card" id="welcomeScreen">
                <h2 style="color: #667eea; margin-bottom: 20px;">Vitajte v dne≈°nom teste!</h2>
                <p style="margin-bottom: 20px; line-height: 1.6;">
                    Test obsahuje <strong>8 textov√Ωch uk√°≈æok</strong> s celkovo <strong>64 ot√°zkami</strong>.<br>
                    Odpovede sa automaticky vyhodnocuj√∫ a v√°≈° v√Ωsledok sa zarad√≠ do denn√©ho rebr√≠ƒçka.
                </p>
                <div class="info-box">
                    üìä Po dokonƒçen√≠ uvid√≠te svoj v√Ωsledok a poradie medzi ostatn√Ωmi ≈°tudentmi
                </div>
                <button class="button" onclick="startTest()">üöÄ Zaƒça≈• test</button>
                <button class="button button-secondary" style="margin-left: 10px;" onclick="showLeaderboard()">üèÜ Rebr√≠ƒçek</button>
            </div>

            <!-- Test Screen -->
            <div class="card hidden" id="testScreen">
                <div class="progress">
                    <div class="progress-bar" id="progressBar"></div>
                </div>
                <div id="testContent"></div>
                <div style="text-align: center; margin-top: 30px;">
                    <button class="button" onclick="submitTest()">‚úÖ Odovzda≈• test</button>
                </div>
            </div>

            <!-- Results Screen -->
            <div class="card hidden" id="resultsScreen">
                <div class="score-display">
                    <h2 id="finalScore">0/64</h2>
                    <p>√öspe≈°nos≈•: <span id="percentage">0%</span></p>
                    <p>ƒåas: <span id="finalTime">00:00</span></p>
                </div>
                
                <h3 style="color: #667eea; margin-bottom: 15px;">üìä Tvoje umiestnenie</h3>
                <div id="userRanking"></div>

                <div style="text-align: center; margin-top: 20px;">
                    <button class="button" onclick="viewAnswers()">üìù Pozrie≈• odpovede</button>
                    <button class="button button-secondary" style="margin-left: 10px;" onclick="showLeaderboard()">üèÜ Rebr√≠ƒçek</button>
                    <button class="button share-button" onclick="shareResults()">üì§ Zdieƒæa≈•</button>
                </div>
            </div>

            <!-- Review Screen -->
            <div class="card hidden" id="reviewScreen">
                <h2 style="color: #667eea; margin-bottom: 20px;">üìù Prehƒæad odpoved√≠</h2>
                <div id="reviewContent"></div>
                <div style="text-align: center; margin-top: 20px;">
                    <button class="button" onclick="showScreen('resultsScreen')">‚Üê Sp√§≈• na v√Ωsledky</button>
                </div>
            </div>

            <!-- Leaderboard Screen -->
            <div class="card hidden" id="leaderboardScreen">
                <h2 style="color: #667eea; margin-bottom: 20px;">üèÜ Denn√Ω rebr√≠ƒçek</h2>
                <div class="leaderboard" id="leaderboardContent"></div>
                <div style="text-align: center; margin-top: 20px;">
                    <button class="button" onclick="showWelcome()">‚Üê Sp√§≈•</button>
                </div>
            </div>

            <!-- Loading Screen -->
            <div class="card hidden" id="loadingScreen">
                <div class="loading">
                    <div class="spinner"></div>
                    <p>Naƒç√≠tavam test... (trv√° 30-60 sek√∫nd)</p>
                </div>
            </div>
        </div>
    </div>

    <script>
        // ============================================
        // CONFIGURATION & INITIALIZATION
        // ============================================
        
        let supabaseClient;
        
        // Hardcoded configuration - keys are set directly
        const config = {
            supabaseUrl: 'https://xbptbimgambfeiilymba.supabase.co',
            supabaseKey: 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InhicHRiaW1nYW1iZmVpaWx5bWJhIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzAzNjcyNTQsImV4cCI6MjA4NTk0MzI1NH0.hLbPMevuO6HVIlyCVYor7s0fu12XHgo5jB0JaNLf-UQ'
            // OpenAI key is now server-side in Netlify Function
        };

        function initializeSupabase() {
            supabaseClient = window.supabase.createClient(config.supabaseUrl, config.supabaseKey);
        }

        // ============================================
        // DATA ABSTRACTION LAYER
        // ============================================
        
        const dbStorage = {
            async getTodayTest() {
                const today = new Date().toISOString().split('T')[0];
                const { data, error } = await supabaseClient
                    .from('tests')
                    .select('*')
                    .eq('date', today)
                    .single();
                
                if (error && error.code !== 'PGRST116') {
                    console.error('Error fetching test:', error);
                    return null;
                }
                return data;
            },

            async saveTest(test) {
                const { data, error } = await supabaseClient
                    .from('tests')
                    .insert([test])
                    .select();
                
                if (error) {
                    console.error('Error saving test:', error);
                    return null;
                }
                return data[0];
            },

            async submitScore(entry) {
                const { data, error } = await supabaseClient
                    .from('leaderboard')
                    .insert([entry])
                    .select();
                
                if (error) {
                    console.error('Error submitting score:', error);
                    return null;
                }
                return data[0];
            },

            async getLeaderboard() {
                const today = new Date().toISOString().split('T')[0];
                const { data, error } = await supabaseClient
                    .from('leaderboard')
                    .select('*')
                    .eq('date', today)
                    .order('score', { ascending: false })
                    .order('time_seconds', { ascending: true });
                
                if (error) {
                    console.error('Error fetching leaderboard:', error);
                    return [];
                }
                return data;
            },

            async getRandomQuestions(textType, count) {
                // Get questions that match text type
                // (Removed 7-day filter - will add back once we have more questions)
                
                // Query for all questions
                const { data, error } = await supabaseClient
                    .from('question_templates')
                    .select('*')
                    .order('usage_count', { ascending: true })
                    .limit(count * 4); // Get extra for filtering

                if (error) {
                    console.error('Error fetching questions:', error);
                    return [];
                }

                // Filter in JavaScript for array contains
                const filtered = data.filter(q => 
                    q.requires_text_type.includes(textType) || q.requires_text_type.includes('any')
                );

                // Shuffle
                const shuffled = filtered.sort(() => Math.random() - 0.5);
                
                // Ensure mix of MC and SA (5 MC, 3 SA per uk√°≈æka)
                const mc = shuffled.filter(q => q.question_type === 'multiple_choice').slice(0, 5);
                const sa = shuffled.filter(q => q.question_type === 'short_answer').slice(0, 3);
                
                return [...mc, ...sa];
            },
                const sa = shuffled.filter(q => q.question_type === 'short_answer').slice(0, 3);
                
                return [...mc, ...sa];
            },

            async updateQuestionUsage(questionIds) {
                const today = new Date().toISOString().split('T')[0];
                
                for (const id of questionIds) {
                    const { data } = await supabaseClient
                        .from('question_templates')
                        .select('usage_count')
                        .eq('id', id)
                        .single();
                    
                    await supabaseClient
                        .from('question_templates')
                        .update({ 
                            usage_count: (data?.usage_count || 0) + 1,
                            last_used: today 
                        })
                        .eq('id', id);
                }
            }
        };

        // ============================================
        // AI TEST GENERATION (USING QUESTION BANK)
        // ============================================
        
        const TEXT_TYPES = [
            {type: 'prose', desc: 'Klasick√° slovensk√° pr√≥za', authors: 'Milo Urban, Jozef C√≠ger Hronsk√Ω, Martin Kukuƒç√≠n, Dobroslav Chrob√°k, ƒΩudov√≠t Fulka, Margita Figuli'},
            {type: 'poetry', desc: 'Slovensk√° po√©zia', authors: 'Ivan Krasko, J√°n Smrek, Andrej Sl√°dkoviƒç, Pavol Orsz√°gh Hviezdoslav, Milan R√∫fus'},
            {type: 'prose', desc: 'Svetov√° pr√≥za', authors: 'Erich Maria Remarque, Ernest Hemingway, Franz Kafka, Fjodor Dostojevskij'},
            {type: 'poetry', desc: 'Svetov√° po√©zia', authors: 'Alexander Pu≈°kin, Lord Byron, Charles Baudelaire, Pablo Neruda'},
            {type: 'journalism', desc: 'Publicistick√Ω text', authors: 'n√°uƒçno-popul√°rny ƒçl√°nok o vede, zdrav√≠, psychol√≥gii, spoloƒçnosti'},
            {type: 'drama', desc: 'Slovensk√° dr√°ma', authors: 'Jozef Gregor Tajovsk√Ω, Ivan Stodola'},
            {type: 'any', desc: 'Esej/√∫vaha', authors: 's√∫ƒçasn√° esej o identite, spoloƒçnosti, umen√≠'},
            {type: 'any', desc: 'Liter√°rna kritika', authors: 'recenzia alebo kritick√° anal√Ωza'}
        ];

        async function generateSingleBlock(blockIndex) {
            const textInfo = TEXT_TYPES[blockIndex];
            
            // 1. GET 8 QUESTIONS FROM DATABASE
            const questions = await dbStorage.getRandomQuestions(textInfo.type, 8);
            
            if (questions.length < 8) {
                throw new Error(`Not enough questions for ${textInfo.type}. Found ${questions.length}, need 8.`);
            }

            // 2. CALL NETLIFY FUNCTION (server-side API call)
            const response = await fetch('/.netlify/functions/generate-block', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    blockIndex,
                    textInfo,
                    questions
                })
            });

            if (!response.ok) {
                const errorData = await response.json();
                throw new Error(errorData.error || 'Failed to generate block');
            }

            const result = await response.json();
            return result;
        }

        async function generateTest() {
            const blocks = [];
            const allQuestionIds = [];
            
            // Generate all 8 blocks
            for (let i = 0; i < 8; i++) {
                const { block, questionIds } = await generateSingleBlock(i);
                blocks.push(block);
                allQuestionIds.push(...questionIds);
            }
            
            // Track question usage
            await dbStorage.updateQuestionUsage(allQuestionIds);
            
            return { blocks };
        }
            const systemPrompt = `Si expert na tvorbu testov pre slovensk√∫ maturity (N√öCEM - Slovensk√Ω jazyk a literat√∫ra, extern√° ƒças≈•).

FORM√ÅT TESTU (PRESNE DODR≈ΩA≈§):
- 8 textov√Ωch uk√°≈æok (blocks)
- Ka≈æd√° uk√°≈æka m√° presne 8 ot√°zok
- Celkovo 64 ot√°zok
- 40 ot√°zok = multiple choice (4 mo≈ænosti, 1 spr√°vna)
- 24 ot√°zok = short answer (kr√°tka odpoveƒè, 1-3 slov√°)

ROZDELENIE TEXTOV√ùCH UK√Å≈ΩOK (VYBER N√ÅHODNE Z POOLOV):

1. KLASICK√Å SLOVENSK√Å PR√ìZA - vyber n√°hodne jedn√©ho autora:
   - Milo Urban, Jozef C√≠ger Hronsk√Ω, Martin Kukuƒç√≠n, Dobroslav Chrob√°k, ƒΩudov√≠t Fulka, Margita Figuli, Jozef Gregor Tajovsk√Ω, Ladislav N√°da≈°i-J√©g√©, Bo≈æena Slanƒç√≠kov√°-Timrava, Janko Jesensk√Ω

2. SLOVENSK√Å PO√âZIA - vyber n√°hodne jedn√©ho autora:
   - Ivan Krasko, J√°n Smrek, Andrej Sl√°dkoviƒç, Pavol Orsz√°gh Hviezdoslav, Milan R√∫fus, Janko Kr√°ƒæ, Svetloz√°r Hurban Vajansk√Ω, Laco Novomesk√Ω, Rudolf Sloboda, Miroslav V√°lek

3. SVETOV√Å PR√ìZA - vyber n√°hodne jedn√©ho autora:
   - Erich Maria Remarque, Ernest Hemingway, Franz Kafka, Fjodor Dostojevskij, Lev Tolstoj, Gabriel Garc√≠a M√°rquez, George Orwell, Albert Camus, John Steinbeck, William Faulkner

4. SVETOV√Å PO√âZIA - vyber n√°hodne jedn√©ho autora:
   - Alexander Pu≈°kin, Lord Byron, Charles Baudelaire, Pablo Neruda, Rainer Maria Rilke, Walt Whitman, Edgar Allan Poe, William Blake, Arthur Rimbaud, Paul Verlaine

5. PUBLICISTICK√ù TEXT - vyber n√°hodn√∫ t√©mu:
   - Veda a v√Ωskum, Zdravie a medic√≠na, Psychol√≥gia, Spoloƒçnos≈• a kult√∫ra, Technol√≥gie, ≈Ωivotn√© prostredie, Hist√≥ria, Umenie

6. SLOVENSK√Å DR√ÅMA - vyber n√°hodne jedn√©ho autora:
   - Jozef Gregor Tajovsk√Ω, Ivan Stodola, J√∫lius Barƒç-Ivan, Peter Karva≈°, Ivan Bukovƒçan, ƒΩubom√≠r Feldek

7. ESEJ/√öVAHA - vyber n√°hodne jedn√©ho s√∫ƒçasn√©ho autora alebo t√©mu:
   - Osobn√° esej o identite, Filozofick√° √∫vaha o ƒçase, Kritick√Ω pohƒæad na spoloƒçnos≈•, Esej o umen√≠, √övaha o pr√≠rode a ƒçloveku

8. LITER√ÅRNA KRITIKA - vyber n√°hodne typ:
   - Recenzia po√©zie, Recenzia pr√≥zy, Kritika dramatu, Anal√Ωza liter√°rneho diela, Porovnanie dvoch autorov

‚ö†Ô∏è KRITICK√â: Ka≈æd√Ω test MUS√ç ma≈• R√îZNYCH autorov! Nepou≈æ√≠vaj Milo Urban 3x za sebou!

DISTRIB√öCIA OT√ÅZOK PRE KA≈ΩD√ö UK√Å≈ΩKU (8 ot√°zok):
- 3x porozumenie textu (STREDN√Å a≈æ ≈§A≈ΩK√Å obtia≈ænos≈• - vy≈æaduje anal√Ωzu, nie len ƒç√≠tanie)
- 2x gramatika/syntax (konkr√©tne pravidl√° - spodobovanie, vetn√© ƒçleny, sklo≈àovanie)
- 2x liter√°rne pojmy/≈°t√Ωl (metafora, epiteton, r√Ωm, ≈°t√Ωl - mus√≠ by≈• v texte)
- 1x lexikol√≥gia (slovotvorba, slovn√© druhy, etymol√≥gia)

‚ö†Ô∏è KRITICK√â PRAVIDL√Å OBTIA≈ΩNOSTI:
- ZAK√ÅZAN√â ƒæahk√© ot√°zky: "Nap√≠≈°te n√°zov ƒçl√°nku", "Kto je autor", "Z ktor√©ho m√©dia je text"
- 20% ƒæahk√© = z√°kladn√© porozumenie ("Ktor√© tvrdenie vypl√Ωva z textu?")
- 50% stredn√© = anal√Ωza ("Ak√Ω liter√°rny prostriedok sa nach√°dza v...?")
- 30% ≈•a≈æk√© = hlbok√© porozumenie alebo kombin√°cia ("Ako autor vyu≈æ√≠va kontrast medzi...?")

‚ö†Ô∏è ROZMANITOS≈§ (KA≈ΩD√Å OT√ÅZKA MUS√ç BY≈§ IN√Å):
- Nepou≈æ√≠vaj 2 ot√°zky o rovnakom liter√°rnom prostriedku (nie 2x o metafore)
- Nepou≈æ√≠vaj 2 ot√°zky o rovnakom gramatickom jave (nie 2x o spodobovan√≠)
- Striedaj aspekty: porozumenie ‚Üí gramatika ‚Üí liter√°rny prostriedok ‚Üí lexika ‚Üí porozumenie...
- Ka≈æd√° ot√°zka testuje IN√ù fragment textu alebo IN√ö vlastnos≈•

TYPY OT√ÅZOK MULTIPLE CHOICE - pou≈æ√≠vaj presne tieto vzory:

‚ö†Ô∏è MASTER QUESTION BANK - VYBER 5 OT√ÅZOK Z TEJTO BANKY PRE KA≈ΩD√ö UK√Å≈ΩKU (V≈†ETKY MUSIA BY≈§ R√îZNE):

KATEG√ìRIA A - POROZUMENIE (vyber 3):
1. "Ktor√© tvrdenie vypl√Ωva z uk√°≈æky?"
2. "Ktor√° z nasleduj√∫cich charakterist√≠k postavy/autora NEVYPL√ùVA z uk√°≈æky?"
3. "Z uk√°≈æky vypl√Ωva, ≈æe autor/postava..."
4. "Ak√Ω vz≈•ah m√° postava X k postave Y podƒæa uk√°≈æky?"
5. "Ak√Ω je hlavn√Ω odkaz/my≈°lienka uk√°≈æky?"
6. "Ktor√© tvrdenie o t√©me/prostred√≠ je spr√°vne?"

KATEG√ìRIA B - GRAMATIKA (vyber 2):
7. "V ktorej mo≈ænosti doch√°dza k znelostnej asimil√°cii/spodobovaniu?"
8. "V ktorej mo≈ænosti sa nach√°dza neurƒçit√Ω slovesn√Ω tvar?"
9. "V ktorej vete sa nach√°dza priamy predmet/podm√©t/pr√≠sudok?"
10. "Ktor√© slovo patr√≠ k IN√âmu slovn√©mu druhu ako ostatn√©?"
11. "V ktorej vete je vetn√Ω ƒçlen vyjadren√Ω inak?"
12. "Ktor√© slovo obsahuje predponu?"
13. "V ktorej mo≈ænosti je pou≈æit√Ω ƒças inak ako v ostatn√Ωch?"
14. "Ktor√© slovo je ohnut√© v inom p√°de ako ostatn√©?"

KATEG√ìRIA C - LITER√ÅRNE POJMY (vyber 2):
15. "V ktorej mo≈ænosti sa nach√°dza metafora?"
16. "Ktor√Ω umeleck√Ω prostriedok dominuje v uk√°≈æke?" (epiteton/personifik√°cia/prirovnanie)
17. "Ak√Ω druh r√Ωmu pou≈æil autor?"
18. "Ktor√° veta obsahuje epiteton?"
19. "V ktorej mo≈ænosti sa nach√°dza personifik√°cia?"
20. "Ak√Ω je rozmer ver≈°a?"

KATEG√ìRIA D - ≈†T√ùL A KONTEXT (vyber 1):
21. "Do ktor√©ho liter√°rneho obdobia patr√≠ uk√°≈æka?"
22. "Ak√Ω je dominantn√Ω ≈°t√Ωl uk√°≈æky?" (hovorov√Ω/odborn√Ω/umeleck√Ω)
23. "Ktor√° charakteristika najlep≈°ie vystihuje t√≥n uk√°≈æky?"
24. "Do ktor√©ho ≈æ√°nru patr√≠ uk√°≈æka?"

‚ö†Ô∏è POVINN√â PRAVIDLO: V 8 uk√°≈ækach NEM√î≈ΩE≈† pou≈æi≈• rovnak√∫ ot√°zku 2x!
Napr√≠klad: Ak pou≈æije≈° ot√°zku #7 (spodobovanie) v uk√°≈æke 1, NEM√î≈ΩE≈† ju pou≈æi≈• v uk√°≈ækach 2-8.

TYPY OT√ÅZOK SHORT ANSWER - MASTER BANK (vyber 3 pre ka≈æd√∫ uk√°≈æku, V≈†ETKY R√îZNE):

SHORT ANSWER KATEG√ìRIA A - GRAMATIKA (vyber 2):
1. "Vyp√≠≈°te z uk√°≈æky slovo, v ktorom doch√°dza k [spodobovaniu/rytmick√©mu kr√°teniu/vokaliz√°cii]."
2. "Nap√≠≈°te z√°kladn√Ω tvar slovesa [X]."
3. "Urƒçte slovn√Ω druh slova [X]."
4. "Vyp√≠≈°te z uk√°≈æky [pr√≠davn√© meno/pr√≠slovku/spojku]."
5. "Nap√≠≈°te slovo [X] v tvare [genit√≠vu/dat√≠vu/akuzat√≠vu] singul√°ru."
6. "Pomenujte vetn√Ω sklad vety: '[cit√°cia]'."
7. "Koƒæko viet obsahuje nasleduj√∫ce s√∫vetie: '[cit√°cia]'?"

SHORT ANSWER KATEG√ìRIA B - LITER√ÅRNA TE√ìRIA (vyber 1):
8. "Pomenujte liter√°rny prostriedok v [konkr√©tnej ƒçasti textu]."
9. "Nap√≠≈°te n√°zov slovotvorn√©ho postupu, ktor√Ωm vzniklo slovo [X]."
10. "Do ktor√©ho liter√°rneho obdobia/smeru patr√≠ autor?"
11. "Ak√Ω typ r√Ωmu je pou≈æit√Ω v b√°sni?"
12. "Nap√≠≈°te meno autora tejto uk√°≈æky." (iba ak nie je uveden√© v hlaviƒçke!)

‚ö†Ô∏è POVINN√â: Ka≈æd√° uk√°≈æka mus√≠ ma≈• IN√ö kombin√°ciu 3 short answer ot√°zok!

‚ö†Ô∏è CRITICAL: Sleduj ktor√© ot√°zky si u≈æ pou≈æil a NIKDY ich neopakuj v r√°mci jedn√©ho testu!

‚ö†Ô∏è POU≈Ω√çVAJ LEN OT√ÅZKY Z MASTER QUESTION BANK VY≈†≈†IE!

GRAMATIKA:
- "V ktorej mo≈ænosti doch√°dza k znelostnej asimil√°cii/spodobovaniu?"
- "V ktorej mo≈ænosti sa nach√°dza neurƒçit√Ω slovesn√Ω tvar?"
- "V ktorej vete sa nach√°dza priamy predmet?"
- "Ktor√© slovo m√° in√∫ ƒças≈• reƒçi ako ostatn√©?" (namiesto poƒç√≠tania slab√≠k)
- "V ktorej vete je pr√≠sudok vyjadren√Ω inak ako v ostatn√Ωch?"
- "Ktor√© slovo je zlo≈æen√© z predpony, kore≈àa a pr√≠pony?"

‚ö†Ô∏è ZAK√ÅZAN√â repetit√≠vne ot√°zky:
- NIKDY sa nep√Ωtaj "Koƒæko slab√≠k m√° slovo X?" viac ako 1x v celom teste
- NIKDY sa nep√Ωtaj rovnak√∫ ot√°zku s inou variantou (napr. "Ktor√© slovo sa l√≠≈°i poƒçtom slab√≠k?" = tie≈æ poƒç√≠tanie slab√≠k)
- AI ƒçasto rob√≠ chyby v poƒç√≠tan√≠ slab√≠k - VYH√ùBAJ SA tejto ot√°zke √∫plne!

‚ö†Ô∏è ROT√ÅCIA OT√ÅZOK - pre ka≈æd√∫ uk√°≈æku vyber IN√â typy:
Uk√°≈æka 1: spodobovanie, priamy predmet, epiteton
Uk√°≈æka 2: slovesn√Ω tvar, vetn√Ω ƒçlen, personifik√°cia  
Uk√°≈æka 3: slovotvorba, s√∫vetie, metafora
Atƒè. - NIKDY neopakuj kombin√°ciu!

‚ö†Ô∏è KA≈ΩD√Å UK√Å≈ΩKA MUS√ç MA≈§ INAK≈†IU KOMBIN√ÅCIU OT√ÅZOK!

PR√çKLADY RE√ÅLNYCH OT√ÅZOK Z N√öCEM TESTOV:

Multiple Choice pr√≠klad 1:
"Ktor√© tvrdenie vypl√Ωva z uk√°≈æky 1?"
(A) ƒålovek, ktor√Ω sa pri vykon√°van√≠ pohybovej aktivity zameriava na svoju techniku pohybu, b√Ωva vyƒçerpanej≈°√≠.
(B) ≈†portov√≠ tr√©neri odpor√∫ƒçaj√∫ profesion√°lnym be≈æcom zamera≈• sa na efekt√≠vnu spotrebu kysl√≠ka.
(C) Tvrdenie o rozpt√Ωlen√≠ je subjekt√≠vne.
(D) V√Ωsledky v√Ωskumu s√∫ v rozpore s te√≥riou.
Spr√°vna odpoveƒè: (A)

Multiple Choice pr√≠klad 2:
"V ktorej mo≈ænosti sa nach√°dza metafora?"
(A) nechcem jeho statky
(B) majetok v √∫cte ma≈•
(C) dvor s dobytkom
(D) hlas svedomia
Spr√°vna odpoveƒè: (D)

Multiple Choice pr√≠klad 3:
"V ktorej mo≈ænosti doch√°dza k znelostnej asimil√°cii/spodobovaniu?"
(A) iba kupova≈• farby
(B) sp√¥sobi≈• si ‚Äûmaliarsky lake≈•"
(C) hudbe, intenz√≠vne maƒæujem
(D) nemohol pohn√∫≈• rukou
Spr√°vna odpoveƒè: (B)

Short Answer pr√≠klad 1:
"Nap√≠≈°te slovo ch√¥dza v tvare genit√≠vu singul√°ru."
Spr√°vna odpoveƒè: "ch√¥dze"

Short Answer pr√≠klad 2:
"Vyp√≠≈°te z ot√°zok neplnov√Ωznamov√© f√°zov√© sloveso."
Spr√°vna odpoveƒè: "zaƒçal"

Short Answer pr√≠klad 3:
"Nap√≠≈°te n√°zov slovotvorn√©ho postupu, ktor√Ωm vznikli slov√° novostavba a maloobchod."
Spr√°vna odpoveƒè: "skladanie"

GRAMATICK√â PRAVIDL√Å NA TESTOVANIE:
- Znelostn√° asimil√°cia (spodobovanie)
- Rytmick√© kr√°tenie
- Sklo≈àovanie cudz√≠ch slov
- Sklo≈àovanie zvierac√≠ch podstatn√Ωch mien
- Pravopis ƒç√≠sloviek
- Interpunkcia (ƒçiarky v s√∫vet√≠)
- Vetn√© ƒçleny (pr√≠stavok, predmet, pr√≠vlastok)

ƒåASTO TESTOVAN√ç AUTORI (ROTUJ ICH, NEPOU≈Ω√çVAJ ROVNAK√ùCH):
- Slovensk√° pr√≥za: Milo Urban, Jozef C√≠ger Hronsk√Ω, Martin Kukuƒç√≠n, Dobroslav Chrob√°k, ƒΩudov√≠t Fulka, Margita Figuli
- Slovensk√° po√©zia: Ivan Krasko, J√°n Smrek, Andrej Sl√°dkoviƒç, Pavol Orsz√°gh Hviezdoslav, Milan R√∫fus
- Slovensk√° dr√°ma: Jozef Gregor Tajovsk√Ω, Ivan Stodola
- Svetov√° literat√∫ra: William Shakespeare, Erich Maria Remarque, Alexander Pu≈°kin, Lord Byron, Ernest Hemingway, Franz Kafka

VYBER 8 R√îZNYCH AUTOROV - ka≈æd√Ω sa m√¥≈æe pou≈æi≈• MAX 1x v teste!

PR√çKLAD TEXTOVEJ UK√Å≈ΩKY (Klasick√° slovensk√° pr√≥za):
N√°zov: ≈Ωiv√Ω biƒç
Autor: Milo Urban
Text: "Ale vtedy, asi po troch rokoch, na jar, pri≈°iel do R√°ztok ƒçlovek v zapr√°≈°enej vojenskej uniforme, odst√°vaj√∫cej od predƒçasne vyschnut√©ho tela. Bol nahnut√Ω k zemi, a ako ≈°iel, [[vietor, ƒço dobehol ƒçasom od h√¥r, svie≈æi, ihrav√Ω]], nadn√°≈°al mu prav√Ω ruk√°v, v ktorom nebolo ruky..."
Uk√°≈æka ot√°zky: "Ktor√Ω umeleck√Ω prostriedok sa nach√°dza vo zv√Ωraznenej ƒçasti?" ‚Üí personifik√°cia

PR√çKLAD TEXTOVEJ UK√Å≈ΩKY (Po√©zia):
N√°zov: Desiate prik√°zanie
Autor: Alexander Sergejeviƒç Pu≈°kin
Text: "Majetok cudz√≠ v √∫cte ma≈• / k√°≈æe n√°m [[z√°kon vekmi v≈æit√Ω]]; / nema≈• tak, bo≈æe, ne≈æn√© city, / vedel by som ho dodr≈æa≈•."
Uk√°≈æka ot√°zky: "Koƒæko slab√≠k m√° zv√Ωraznen√© slovn√© spojenie?" ‚Üí 7

PR√çKLAD TEXTOVEJ UK√Å≈ΩKY (Po√©zia):
N√°zov: Desiate prik√°zanie
Autor: Alexander Sergejeviƒç Pu≈°kin
Text: "Majetok cudz√≠ v √∫cte ma≈• / k√°≈æe n√°m z√°kon vekmi v≈æit√Ω; / nema≈• tak, bo≈æe, ne≈æn√© city, / vedel by som ho dodr≈æa≈•. / Ukr√°ti≈• bl√≠≈æneho, to nikdy, / nechcem ja jeho statky, dom..."

PR√çKLAD TEXTOVEJ UK√Å≈ΩKY (Publicistika):
N√°zov: Ak beh√°te s hudbou, pohyb je efekt√≠vnej≈°√≠
Zdroj: Denn√≠k N
Text: "Nov√° ≈°t√∫dia o behu naznaƒçuje, ≈æe ƒç√≠m viac sa pri pohybe s√∫stred√≠me na to, ako ho vykon√°vame, t√Ωm je pre n√°s nam√°havej≈°√≠. Len ƒço v≈°ak n√°jdeme urƒçit√© rozpt√Ωlenie, vynalo≈æen√© √∫silie bude pre na≈°e telo menej n√°roƒçn√©..."

PO≈ΩIADAVKY NA GENEROVAN√ù TEST:
1. Ka≈æd√° uk√°≈æka mus√≠ ma≈• 150-300 slov
2. Texty musia by≈• realistick√© (nie generick√Ω AI jazyk)
3. Ot√°zky musia by≈• PRESNE v slovenƒçine ako v re√°lnych testoch
4. Gramatick√© ot√°zky musia testova≈• konkr√©tne pravidl√°
5. Short answer ot√°zky musia ma≈• JEDNU presne definovan√∫ spr√°vnu odpoveƒè
6. Multiple choice mus√≠ ma≈• 4 mo≈ænosti (A, B, C, D)
7. ‚ö†Ô∏è AK chce≈° pou≈æi≈• ot√°zku o "zv√Ωraznenej ƒçasti", pou≈æi znaƒçku [[text]] v uk√°≈æke na oznaƒçenie zv√Ωraznen√©ho textu
8. Pr√≠klad: Text "Bol to [[kr√°sny de≈à]], pln√Ω slnka." + ot√°zka "Ak√Ω slovn√Ω druh je zv√Ωraznen√© slovn√© spojenie?"
9. Znaƒçka [[...]] sa zobraz√≠ ako ≈ælt√Ω highlight v texte

‚ö†Ô∏è ZAK√ÅZAN√â TYPY OT√ÅZOK:
- NIKDY sa nep√Ωtaj "Nap√≠≈°te n√°zov ƒçl√°nku/uk√°≈æky" - je to trivi√°lne, n√°zov je uveden√Ω nad textom
- NIKDY nepou≈æ√≠vaj ot√°zky ako "Nap√≠≈°te n√°zov diela autora X" bez konkr√©tneho kontextu - autor m√¥≈æe ma≈• 20 diel
- NIKDY sa neopakuj - ka≈æd√° ot√°zka MUS√ç by≈• unik√°tna (in√° t√©ma, in√Ω aspekt textu)
- NIKDY sa nep√Ωtaj na inform√°cie priamo uveden√© v titulke/metad√°tach
- Ot√°zky musia testova≈• POROZUMENIE, ANAL√ùZU alebo GRAMATIKU - nie memorovanie z√°kladn√Ωch faktov

SPR√ÅVNE short answer ot√°zky:
‚úì "Vyp√≠≈°te z uk√°≈æky slovo, v ktorom doch√°dza k spodobovaniu" - presn√° odpoveƒè z textu
‚úì "Nap√≠≈°te z√°kladn√Ω tvar slovesa 'i≈°iel'" - jednoznaƒçn√° odpoveƒè (√≠s≈•)
‚úì "Pomenujte vetn√Ω sklad vety: 'Pr≈°√≠.'" - jednoznaƒçn√° odpoveƒè (slovesno-menn√Ω)
‚úì "Do ktor√©ho liter√°rneho smeru patr√≠ autor tejto uk√°≈æky?" - vypl√Ωva z kontextu a ≈°t√Ωlu

NESPR√ÅVNE short answer ot√°zky:
‚úó "Nap√≠≈°te n√°zov ƒçl√°nku" - je to v titulke, nie je to test znalost√≠
‚úó "Nap√≠≈°te n√°zov diela Ivana Krasku" - m√° viac diel, nemo≈æno urƒçi≈• ktor√©
‚úó "Z ktor√©ho zdroja poch√°dza tento text?" - v titulke je "Denn√≠k N", trivi√°lne

V√ùSTUPN√ù JSON FORM√ÅT:
{
  "blocks": [
    {
      "title": "N√°zov diela / typ textu",
      "text": "Cel√Ω text uk√°≈æky (150-300 slov)",
      "author": "Meno autora",
      "genre": "pr√≥za/po√©zia/publicistika/dr√°ma/esej",
      "questions": [
        {
          "id": 1,
          "question": "Text ot√°zky presne ako v N√öCEM",
          "type": "multiple_choice",
          "options": ["A", "B", "C", "D"],
          "correct": "A"
        },
        {
          "id": 2,
          "question": "Text ot√°zky presne ako v N√öCEM",
          "type": "short_answer",
          "correct": "presn√° odpoveƒè"
        }
      ]
    }
  ]
}

KRITICK√â PRAVIDL√Å:
- 5 ot√°zok MUSIA by≈• multiple choice
- 3 ot√°zky MUSIA by≈• short answer
- Ot√°zky musia pokr√Ωva≈•: porozumenie (2-3), gramatiku (2-3), liter√°rnu te√≥riu (1-2), lexikol√≥giu (1)
- Nepou≈æ√≠vaj fr√°zy ako "based on", "according to" - p√≠≈° prirodzene po slovensky
- Short answer odpovede musia by≈• PRESN√â (nie "pribli≈æne" ani "mo≈æno")
- Ka≈æd√Ω text mus√≠ by≈• in√Ω ≈æ√°ner`;
        // ============================================
        // APP STATE
        // ============================================
        
        let currentTest = null;
        let startTime = null;
        let timerInterval = null;
        let userAnswers = {};
        let testResults = null;

        // ============================================
        // UI FUNCTIONS
        // ============================================
        
        function showScreen(screenId) {
            ['welcomeScreen', 'testScreen', 'resultsScreen', 'reviewScreen', 'leaderboardScreen', 'loadingScreen'].forEach(id => {
                document.getElementById(id).classList.add('hidden');
            });
            document.getElementById(screenId).classList.remove('hidden');
        }

        function showWelcome() {
            showScreen('welcomeScreen');
            stopTimer();
        }

        function updateProgress() {
            const answered = Object.keys(userAnswers).length;
            const total = currentTest ? currentTest.blocks.reduce((sum, b) => sum + b.questions.length, 0) : 64;
            const percent = (answered / total) * 100;
            document.getElementById('progressBar').style.width = percent + '%';
        }

        // ============================================
        // TIMER
        // ============================================
        
        function startTimer() {
            startTime = Date.now();
            document.getElementById('timer').classList.remove('hidden');
            timerInterval = setInterval(updateTimer, 1000);
        }

        function updateTimer() {
            const elapsed = Math.floor((Date.now() - startTime) / 1000);
            const minutes = Math.floor(elapsed / 60);
            const seconds = elapsed % 60;
            document.getElementById('time').textContent = 
                `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
        }

        function stopTimer() {
            if (timerInterval) {
                clearInterval(timerInterval);
                timerInterval = null;
            }
            document.getElementById('timer').classList.add('hidden');
        }

        function getElapsedSeconds() {
            return Math.floor((Date.now() - startTime) / 1000);
        }

        // ============================================
        // TEST FUNCTIONS
        // ============================================
        
        async function startTest() {
            showScreen('loadingScreen');
            
            // Try to get today's test
            let test = await dbStorage.getTodayTest();
            
            if (!test) {
                // Generate new test
                try {
                    const testData = await generateTest();
                    const today = new Date().toISOString().split('T')[0];
                    test = {
                        date: today,
                        content: testData
                    };
                    await dbStorage.saveTest(test);
                } catch (error) {
                    alert('Chyba pri generovan√≠ testu: ' + error.message);
                    showWelcome();
                    return;
                }
            }

            currentTest = test.content;
            userAnswers = {};
            renderTest();
            showScreen('testScreen');
            startTimer();
        }

        function renderTest() {
            const container = document.getElementById('testContent');
            container.innerHTML = '';

            currentTest.blocks.forEach((block, blockIdx) => {
                const blockDiv = document.createElement('div');
                blockDiv.className = 'text-block';
                
                let authorInfo = '';
                if (block.author) {
                    authorInfo = `<p class="author-info">${block.author}${block.genre ? ` ‚Ä¢ ${block.genre}` : ''}</p>`;
                }
                
                // Convert [[text]] to <span class="highlight">text</span>
                const highlightedText = block.text.replace(/\[\[(.*?)\]\]/g, '<span class="highlight">$1</span>');
                
                blockDiv.innerHTML = `
                    <h3>Uk√°≈æka ${blockIdx + 1}: ${block.title}</h3>
                    ${authorInfo}
                    <div class="text-content">${highlightedText}</div>
                `;

                block.questions.forEach((q, qIdx) => {
                    const questionDiv = document.createElement('div');
                    questionDiv.className = 'question';
                    
                    const questionId = `q_${blockIdx}_${qIdx}`;
                    
                    if (q.type === 'multiple_choice') {
                        questionDiv.innerHTML = `
                            <div class="question-text">${qIdx + 1}. ${q.question}</div>
                            <div class="options">
                                ${q.options.map((opt, optIdx) => {
                                    const letter = String.fromCharCode(65 + optIdx); // A, B, C, D
                                    return `
                                    <div class="option">
                                        <input type="radio" 
                                               name="${questionId}" 
                                               id="${questionId}_${letter}"
                                               value="${letter}"
                                               onchange="saveAnswer('${questionId}', '${letter}')">
                                        <label for="${questionId}_${letter}">${opt}</label>
                                    </div>
                                `}).join('')}
                            </div>
                        `;
                    } else {
                        questionDiv.innerHTML = `
                            <div class="question-text">${qIdx + 1}. ${q.question}</div>
                            <input type="text" 
                                   id="${questionId}"
                                   placeholder="Va≈°a odpoveƒè..."
                                   onchange="saveAnswer('${questionId}', this.value)">
                        `;
                    }
                    
                    blockDiv.appendChild(questionDiv);
                });

                container.appendChild(blockDiv);
            });
        }

        function saveAnswer(questionId, answer) {
            userAnswers[questionId] = answer;
            updateProgress();
        }

        function normalizeAnswer(str) {
            return str.toLowerCase()
                .trim()
                .normalize('NFD')
                .replace(/[\u0300-\u036f]/g, '') // Remove diacritics for comparison
                .replace(/\s+/g, ' ')
                .replace(/[.,;:!?]/g, '');
        }

        async function submitTest() {
            const totalQuestions = currentTest.blocks.reduce((sum, b) => sum + b.questions.length, 0);
            const answeredCount = Object.keys(userAnswers).length;

            if (answeredCount < totalQuestions) {
                if (!confirm(`Odpovedali ste na ${answeredCount} z ${totalQuestions} ot√°zok. Chcete test naozaj odovzda≈•?`)) {
                    return;
                }
            }

            stopTimer();
            const timeSeconds = getElapsedSeconds();

            // Calculate score and store results
            let correct = 0;
            const results = [];
            
            currentTest.blocks.forEach((block, blockIdx) => {
                block.questions.forEach((q, qIdx) => {
                    const questionId = `q_${blockIdx}_${qIdx}`;
                    const userAnswer = userAnswers[questionId] || '';
                    let isCorrect = false;
                    
                    if (q.type === 'multiple_choice') {
                        isCorrect = userAnswer === q.correct;
                    } else {
                        isCorrect = normalizeAnswer(userAnswer) === normalizeAnswer(q.correct);
                    }
                    
                    if (isCorrect) correct++;
                    
                    results.push({
                        blockIdx,
                        qIdx,
                        question: q,
                        userAnswer,
                        correct: isCorrect
                    });
                });
            });

            testResults = { results, correct, totalQuestions, timeSeconds };

            // Show results
            document.getElementById('finalScore').textContent = `${correct}/${totalQuestions}`;
            document.getElementById('percentage').textContent = `${Math.round((correct / totalQuestions) * 100)}%`;
            
            const minutes = Math.floor(timeSeconds / 60);
            const seconds = timeSeconds % 60;
            document.getElementById('finalTime').textContent = 
                `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;

            // Save to leaderboard
            const userName = prompt('Zadajte va≈°e meno pre rebr√≠ƒçek:') || 'Anonym';
            const today = new Date().toISOString().split('T')[0];
            
            await dbStorage.submitScore({
                date: today,
                name: userName,
                score: correct,
                time_seconds: timeSeconds,
                timestamp: new Date().toISOString()
            });

            // Show user ranking
            const leaderboard = await dbStorage.getLeaderboard();
            const userEntries = leaderboard.filter(entry => 
                entry.name === userName && 
                entry.score === correct && 
                entry.time_seconds === timeSeconds
            );
            
            const userEntry = userEntries[userEntries.length - 1];
            const userRank = leaderboard.indexOf(userEntry) + 1;

            document.getElementById('userRanking').innerHTML = `
                <div class="leaderboard-item" style="background: #667eea; color: white;">
                    <div>
                        <span class="rank" style="color: white;">#${userRank}</span>
                        <strong>${userName}</strong>
                    </div>
                    <div>
                        ${correct}/${totalQuestions} bodov | ${minutes}:${seconds.toString().padStart(2, '0')}
                    </div>
                </div>
            `;

            showScreen('resultsScreen');
        }

        function viewAnswers() {
            if (!testResults) return;
            
            const container = document.getElementById('reviewContent');
            container.innerHTML = '';
            
            let currentBlock = -1;
            
            testResults.results.forEach(result => {
                const block = currentTest.blocks[result.blockIdx];
                
                // Add block header if new block
                if (result.blockIdx !== currentBlock) {
                    currentBlock = result.blockIdx;
                    const blockHeader = document.createElement('div');
                    blockHeader.className = 'text-block';
                    blockHeader.innerHTML = `
                        <h3>Uk√°≈æka ${result.blockIdx + 1}: ${block.title}</h3>
                        ${block.author ? `<p class="author-info">${block.author}</p>` : ''}
                    `;
                    container.appendChild(blockHeader);
                }
                
                // Add question review
                const questionDiv = document.createElement('div');
                questionDiv.className = `question ${result.correct ? 'correct' : 'incorrect'}`;
                
                const q = result.question;
                
                if (q.type === 'multiple_choice') {
                    const optionsHTML = q.options.map((opt, idx) => {
                        const letter = String.fromCharCode(65 + idx);
                        const isUserAnswer = result.userAnswer === letter;
                        const isCorrectAnswer = q.correct === letter;
                        
                        let className = 'option';
                        if (isCorrectAnswer) className += ' correct-answer';
                        else if (isUserAnswer && !result.correct) className += ' user-wrong';
                        
                        let marker = '';
                        if (isCorrectAnswer) marker = ' ‚úì';
                        if (isUserAnswer && !result.correct) marker = ' ‚úó';
                        
                        return `<div class="${className}">${opt}${marker}</div>`;
                    }).join('');
                    
                    questionDiv.innerHTML = `
                        <div class="question-text">${result.qIdx + 1}. ${q.question}</div>
                        <div class="options">${optionsHTML}</div>
                        <div class="answer-indicator ${result.correct ? 'correct' : 'incorrect'}">
                            ${result.correct ? '‚úì Spr√°vne' : `‚úó Nespr√°vne - Spr√°vna odpoveƒè: ${q.correct}`}
                        </div>
                    `;
                } else {
                    questionDiv.innerHTML = `
                        <div class="question-text">${result.qIdx + 1}. ${q.question}</div>
                        <div class="answer-indicator ${result.correct ? 'correct' : 'incorrect'}">
                            Tvoja odpoveƒè: <strong>${result.userAnswer || '(bez odpovede)'}</strong><br>
                            Spr√°vna odpoveƒè: <strong>${q.correct}</strong>
                            ${result.correct ? ' ‚úì' : ' ‚úó'}
                        </div>
                    `;
                }
                
                container.appendChild(questionDiv);
            });
            
            showScreen('reviewScreen');
        }

        async function showLeaderboard() {
            showScreen('loadingScreen');
            const leaderboard = await dbStorage.getLeaderboard();
            
            const container = document.getElementById('leaderboardContent');
            
            if (leaderboard.length === 0) {
                container.innerHTML = '<p style="text-align: center; color: #888;">Zatiaƒæ nikto nevyplnil dne≈°n√Ω test.</p>';
            } else {
                container.innerHTML = leaderboard.map((entry, idx) => {
                    const minutes = Math.floor(entry.time_seconds / 60);
                    const seconds = entry.time_seconds % 60;
                    const isTop3 = idx < 3;
                    const rankClass = idx === 0 ? 'rank-1' : idx === 1 ? 'rank-2' : idx === 2 ? 'rank-3' : '';
                    
                    return `
                        <div class="leaderboard-item ${isTop3 ? 'top-3 ' + rankClass : ''}">
                            <div>
                                <span class="rank">#${idx + 1}</span>
                                <strong>${entry.name}</strong>
                            </div>
                            <div>
                                ${entry.score}/64 bodov | ${minutes}:${seconds.toString().padStart(2, '0')}
                            </div>
                        </div>
                    `;
                }).join('');
            }
            
            showScreen('leaderboardScreen');
        }

        function shareResults() {
            const score = document.getElementById('finalScore').textContent;
            const percentage = document.getElementById('percentage').textContent;
            const url = window.location.href;
            
            const text = `üìö Moja dne≈°n√° maturita z SJL:\n${score} (${percentage})\n\nSk√∫s to aj ty: ${url}`;
            
            if (navigator.share) {
                navigator.share({ text });
            } else {
                navigator.clipboard.writeText(text);
                alert('Text skop√≠rovan√Ω do schr√°nky!');
            }
        }

        // ============================================
        // INITIALIZATION
        // ============================================
        
        function init() {
            const today = new Date();
            const options = { year: 'numeric', month: 'long', day: 'numeric' };
            document.getElementById('dateDisplay').textContent = today.toLocaleDateString('sk-SK', options);
        }

        // Start app
        window.addEventListener('DOMContentLoaded', () => {
            // Initialize Supabase immediately
            initializeSupabase();
            
            // Initialize the app
            init();
        });
    </script>
</body>
</html>
